<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Scan Absensi Siswa</title>
    
    <!-- Library untuk QR/Barcode Scanner -->
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    
    <!-- Library Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            padding: 20px;
            text-align: center;
        }
        video {
            width: 90%;
            max-width: 480px;
            border: 4px solid #3498db;
            border-radius: 12px;
        }
        h1 {
            margin-bottom: 10px;
        }
        #result {
            margin-top: 10px;
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        #status {
            color: green;
            font-weight: bold;
        }
        table {
            width: 100%;
            margin-top: 30px;
            border-collapse: collapse;
            background: white;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            font-size: 14px;
            text-align: left;
        }
        th {
            background-color: #3498db;
            color: white;
            text-align: center;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .delete-btn:hover {
            background-color: #c0392b;
        }
        .button-group {
            margin-top: 20px;
        }
        .button-group button {
            padding: 10px 15px;
            font-size: 1em;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            margin: 0 5px;
        }
        #delete-all-btn {
            background-color: #e74c3c;
            color: white;
        }
    </style>
</head>
<body>
    <h1>ðŸ“· Scan Absensi Siswa</h1>
    <video id="video" playsinline></video>
    <p>Barcode Terbaca: <span id="result">-</span></p>
    <p id="status"></p>

    <div class="button-group">
        <button id="delete-all-btn">Hapus Semua Data Absensi</button>
    </div>

    <h2>ðŸ“‹ Tabel Absensi</h2>
    <table>
        <thead>
            <tr>
                <th>No</th>
                <th>ID Card</th>
                <th>Nama</th>
                <th>Pagi</th>
                <th>Pulang</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody id="tabel-hasil"></tbody>
    </table>

    <!-- Skrip Data Siswa (Pastikan file ini ada di folder yang sama) -->
    <script src="data-siswa.js"></script>

    <script>
        // =================================================================
        //                 KONFIGURASI SUPABASE
        // =================================================================
        // ERROR 'Failed to fetch' ini biasanya terjadi jika URL atau Anon Key salah,
        // atau jika ada masalah dengan CORS. PASTIKAN UNTUK MENGGANTI NILAI DI BAWAH INI
        // DENGAN URL DAN KUNCI DARI PROYEK SUPABASE ANDA YANG SEBENARNYA.
        const SUPABASE_URL = 'https://rhykjbefaojfjwyaouogc.supabase.co'; 
        const SUPABASE_ANON_KEY = 'sb_publishable_J1-LPxsXBL4S-991TZuKWg_HM3EdEwz';
        
        // Perbaikan untuk ReferenceError
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // =================================================================

        const statusElement = document.getElementById('status');
        const resultElement = document.getElementById('result');
        const tabelHasil = document.getElementById('tabel-hasil');
        const deleteAllBtn = document.getElementById('delete-all-btn');

        // Fungsi untuk merender baris tabel dari data Supabase
        function renderRow(record) {
            let row = document.getElementById(`row-${record.siswa_id}`);
            if (!row) {
                row = document.createElement('tr');
                row.id = `row-${record.siswa_id}`;
                const rowCount = tabelHasil.querySelectorAll('tr').length + 1;
                row.innerHTML = `
                    <td>${rowCount}</td>
                    <td>${record.siswa_id}</td>
                    <td>${record.nama}</td>
                    <td id="pagi-${record.siswa_id}">${record.pagi ? new Date(record.pagi).toLocaleTimeString('id-ID') : '-'}</td>
                    <td id="pulang-${record.siswa_id}">${record.pulang ? new Date(record.pulang).toLocaleTimeString('id-ID') : '-'}</td>
                    <td><button class="delete-btn" onclick="hapusAbsensi('${record.siswa_id}')">Hapus</button></td>
                `;
                tabelHasil.appendChild(row);
            } else {
                const pagiCell = document.getElementById(`pagi-${record.siswa_id}`);
                const pulangCell = document.getElementById(`pulang-${record.siswa_id}`);
                if (record.pagi) pagiCell.textContent = new Date(record.pagi).toLocaleTimeString('id-ID');
                if (record.pulang) pulangCell.textContent = new Date(record.pulang).toLocaleTimeString('id-ID');
            }
        }

        // Fungsi untuk mengambil data absensi dari Supabase saat halaman dimuat
        async function loadAbsensi() {
            const { data, error } = await supabase
                .from('absensi_siswa')
                .select('*')
                .order('created_at', { ascending: true });

            if (error) {
                console.error('Gagal memuat data:', error);
                statusElement.textContent = 'Error saat memuat data.';
                statusElement.style.color = 'red';
                return;
            }

            // Kosongkan tabel sebelum merender ulang
            tabelHasil.innerHTML = '';
            data.forEach(renderRow);
        }

        // Panggil fungsi untuk memuat data
        loadAbsensi();

        async function prosesAbsen(scannedId) {
            const siswa = dataSiswa.find(s => s.id === scannedId);

            if (!siswa) {
                statusElement.textContent = 'ID tidak ditemukan';
                statusElement.style.color = 'red';
                return;
            }

            const now = new Date();
            const jam = now.getHours();
            const waktu = jam < 12 ? 'pagi' : 'pulang';

            // Cari data absensi siswa di Supabase
            const { data: existingRecord, error: fetchError } = await supabase
                .from('absensi_siswa')
                .select('*')
                .eq('siswa_id', siswa.id)
                .limit(1)
                .single();

            if (fetchError && fetchError.code !== 'PGRST116') { // PGRST116 berarti "tidak ditemukan"
                console.error('Error saat mencari record:', fetchError);
                return;
            }

            if (existingRecord) {
                // Jika data sudah ada, perbarui waktu absensinya
                if (existingRecord[waktu]) {
                    statusElement.textContent = `Sudah absen ${waktu}`;
                    statusElement.style.color = 'orange';
                    return;
                }

                const updatePayload = {
                    [waktu]: now.toISOString()
                };

                const { data, error } = await supabase
                    .from('absensi_siswa')
                    .update(updatePayload)
                    .eq('id', existingRecord.id)
                    .select()
                    .single();

                if (error) {
                    console.error('Error saat memperbarui data:', error);
                    return;
                }
                renderRow(data);
                statusElement.textContent = `Absensi ${waktu} berhasil!`;
                statusElement.style.color = 'green';

            } else {
                // Jika data belum ada, buat record baru
                const insertPayload = {
                    siswa_id: siswa.id,
                    nama: siswa.nama,
                    pagi: now.toISOString(),
                    pulang: null
                };

                const { data, error } = await supabase
                    .from('absensi_siswa')
                    .insert(insertPayload)
                    .select()
                    .single();
                
                if (error) {
                    console.error('Error saat menyimpan data:', error);
                    return;
                }
                renderRow(data);
                statusElement.textContent = `Absensi ${waktu} berhasil!`;
                statusElement.style.color = 'green';
            }
        }

        // Fungsi untuk menghapus satu record berdasarkan ID siswa
        async function hapusAbsensi(siswaId) {
            const konfirmasi = confirm(`Apakah Anda yakin ingin menghapus data absensi untuk siswa dengan ID ${siswaId}?`);
            if (!konfirmasi) return;

            const { error } = await supabase
                .from('absensi_siswa')
                .delete()
                .eq('siswa_id', siswaId);

            if (error) {
                console.error('Gagal menghapus data:', error);
                statusElement.textContent = 'Error saat menghapus data.';
                statusElement.style.color = 'red';
                return;
            }

            // Muat ulang tabel untuk menampilkan perubahan
            loadAbsensi();
            statusElement.textContent = 'Data berhasil dihapus!';
            statusElement.style.color = 'green';
        }

        // Fungsi untuk menghapus semua data absensi
        async function hapusSemuaAbsensi() {
            const konfirmasi = confirm('Apakah Anda yakin ingin menghapus SEMUA data absensi? Aksi ini tidak bisa dibatalkan.');
            if (!konfirmasi) return;

            const { error } = await supabase
                .from('absensi_siswa')
                .delete()
                .neq('siswa_id', 'non-existent-id'); // Menghapus semua baris dengan trik ini

            if (error) {
                console.error('Gagal menghapus semua data:', error);
                statusElement.textContent = 'Error saat menghapus semua data.';
                statusElement.style.color = 'red';
                return;
            }

            // Kosongkan tabel di UI dan muat ulang
            tabelHasil.innerHTML = '';
            statusElement.textContent = 'Semua data absensi berhasil dihapus!';
            statusElement.style.color = 'green';
        }

        // Tambahkan event listener untuk tombol "Hapus Semua"
        deleteAllBtn.addEventListener('click', hapusSemuaAbsensi);

        // ZXing setup
        const codeReader = new ZXing.BrowserMultiFormatReader();
        codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
            if (result) {
                const scannedId = result.text.trim();
                resultElement.textContent = scannedId;
                prosesAbsen(scannedId);
            }
        });
    </script>
</body>
</html>
