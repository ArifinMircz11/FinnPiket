<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Absensi Barcode Siswa</title>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f8; text-align: center; }
    h1 { color: #2c3e50; }
    video { width: 90%; max-width: 480px; border: 4px solid #3498db; border-radius: 12px; margin: 20px 0; }
    table { width: 90%; margin: 20px auto; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #3498db; color: white; }
    tr:nth-child(even) { background: #ecf0f1; }
    #result { font-weight: bold; margin: 10px; color: #27ae60; }
    #debug { color: #e67e22; }
  </style>
</head>
<body>
  <h1>üì∑ Absensi Barcode</h1>
  <video id="video" playsinline autoplay></video>
  <p id="result">Menunggu scan...</p>
  <p id="debug"></p>

  <table>
    <thead>
      <tr>
        <th>NISN</th>
        <th>Nama</th>
        <th>Status</th>
        <th>Waktu</th>
      </tr>
    </thead>
    <tbody id="absen-table"></tbody>
  </table>

<script>
  // === KONFIGURASI SUPABASE ===
  const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co";
  const SUPABASE_KEY = "YOUR-ANON-KEY";
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const videoElement = document.getElementById("video");
  const resultEl = document.getElementById("result");
  const debugEl = document.getElementById("debug");
  const tableBody = document.getElementById("absen-table");

  const codeReader = new ZXing.BrowserMultiFormatReader();
  let lastScanned = "";
  let lastScanTime = 0;
  const SCAN_COOLDOWN_MS = 3000; // 3 detik

  // Fungsi catat absensi
  async function prosesAbsensi(nisn) {
    try {
      let { data: siswa, error } = await supabase
        .from("siswa")
        .select("nama")
        .eq("nisn", nisn)
        .single();

      if (error || !siswa) {
        resultEl.textContent = "‚ùå NISN tidak ditemukan di database";
        return;
      }

      const today = new Date().toISOString().slice(0,10);
      let { data: absenHariIni } = await supabase
        .from("absensi")
        .select("*")
        .eq("nisn", nisn)
        .gte("waktu", today + "T00:00:00")
        .lte("waktu", today + "T23:59:59");

      let status = "Check-in";
      if (absenHariIni && absenHariIni.length > 0) {
        status = "Check-out";
      }

      const waktu = new Date().toLocaleString();
      await supabase.from("absensi").insert([
        { nisn: nisn, nama: siswa.nama, status: status, waktu: new Date().toISOString() }
      ]);

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${nisn}</td>
        <td>${siswa.nama}</td>
        <td>${status}</td>
        <td>${waktu}</td>`;
      tableBody.prepend(row);

      resultEl.textContent = `‚úÖ ${siswa.nama} (${nisn}) ${status} berhasil`;
    } catch (err) {
      console.error(err);
      debugEl.textContent = "‚ö†Ô∏è Gagal memproses absensi";
    }
  }

  // Inisialisasi kamera (pilih kamera belakang bila ada)
  codeReader.listVideoInputDevices().then(devices => {
    if (!devices.length) {
      debugEl.textContent = "‚ùå Kamera tidak ditemukan";
      return;
    }
    const cam = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];
    codeReader.decodeFromVideoDevice(cam.deviceId, videoElement, (resultObj, err) => {
      if (resultObj) {
        const nisn = resultObj.text.trim();
        const now = Date.now();
        if (nisn !== lastScanned || now - lastScanTime > SCAN_COOLDOWN_MS) {
          lastScanned = nisn;
          lastScanTime = now;
          resultEl.textContent = `üîç Terbaca NISN: ${nisn}`;
          prosesAbsensi(nisn);
        }
      } else if (err && !(err instanceof ZXing.NotFoundException)) {
        debugEl.textContent = "‚ö†Ô∏è Error scan: " + err;
      }
    });
  }).catch(err => {
    debugEl.textContent = "‚ö†Ô∏è Gagal akses kamera: " + err;
    console.error(err);
  });
</script>
</body>
</html>
