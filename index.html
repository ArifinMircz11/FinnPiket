<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Absensi Barcode Siswa</title>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f8; text-align: center; }
    h1 { color: #2c3e50; }
    video { width: 90%; max-width: 480px; border: 4px solid #3498db; border-radius: 12px; margin: 20px 0; }
    table { width: 95%; margin: 20px auto; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #3498db; color: white; }
    tr:nth-child(even) { background: #ecf0f1; }
    #result { font-weight: bold; margin: 10px; color: #27ae60; }
    #debug { color: #e67e22; }
    .toolbar button { margin: 5px; padding: 8px 12px; border: none; border-radius: 6px; background: #3498db; color: white; cursor: pointer; }
    .toolbar button:hover { background: #2980b9; }
  </style>
</head>
<body>
  <h1>üì∑ Absensi Barcode</h1>

  <!-- Toolbar kegiatan -->
  <div class="toolbar">
    <button onclick="setMode('checkin')">Check In</button>
    <button onclick="setMode('duha')">Duha</button>
    <button onclick="setMode('zuhur')">Zuhur</button>
    <button onclick="setMode('checkout')">Check Out</button>
  </div>

  <video id="video" playsinline autoplay></video>
  <p id="result">Menunggu scan...</p>
  <p id="debug"></p>

  <table>
    <thead>
      <tr>
        <th>NISN</th>
        <th>Nama</th>
        <th>Kelas</th>
        <th>Jam Masuk</th>
        <th>Jam Pulang</th>
        <th>Check In</th>
        <th>Duha</th>
        <th>Zuhur</th>
        <th>Check Out</th>
        <th>Terlambat</th>
      </tr>
    </thead>
    <tbody id="absen-table"></tbody>
  </table>

<script>
  const videoElement = document.getElementById("video");
  const resultEl = document.getElementById("result");
  const debugEl = document.getElementById("debug");
  const tableBody = document.getElementById("absen-table");

  const codeReader = new ZXing.BrowserMultiFormatReader();
  let lastScanned = "";
  let lastScanTime = 0;
  const SCAN_COOLDOWN_MS = 3000; // 3 detik

  // mode absensi (default Check In)
  let currentMode = "checkin";
  function setMode(mode) {
    currentMode = mode;
    resultEl.textContent = "Mode aktif: " + mode.toUpperCase();
  }

  // data siswa default (bisa disesuaikan dari Excel)
  const siswaData = {
    "24048": { nama: "ADELIA SRI SUNDARI", kelas: "10 A" },
    "24149": { nama: "ADITYA RAHMAN", kelas: "10 A" },
    "0101647622": { nama: "MUHAMMAD HIDAYAT", kelas: "10 A" },
    "0108235279": { nama: "ZAHRATUN NISA", kelas: "10 A" }
    // tambahkan sesuai kebutuhan
  };

  // catat absensi
  function prosesAbsensi(nisn) {
    if (!siswaData[nisn]) {
      resultEl.textContent = "‚ùå NISN tidak terdaftar";
      return;
    }

    const siswa = siswaData[nisn];
    const waktu = new Date();
    const waktuStr = waktu.toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });

    // cari baris siswa di tabel
    let row = document.getElementById("row-" + nisn);
    if (!row) {
      row = document.createElement("tr");
      row.id = "row-" + nisn;
      row.innerHTML = `
        <td>${nisn}</td>
        <td>${siswa.nama}</td>
        <td>${siswa.kelas}</td>
        <td>07:30</td>
        <td>16:00</td>
        <td></td><td></td><td></td><td></td><td></td>
      `;
      tableBody.appendChild(row);
    }

    const cells = row.getElementsByTagName("td");

    if (currentMode === "checkin") {
      cells[5].textContent = waktuStr;
      // hitung terlambat
      if (waktu.getHours() > 7 || (waktu.getHours() === 7 && waktu.getMinutes() > 30)) {
        cells[9].textContent = "Ya";
      } else {
        cells[9].textContent = "Tidak";
      }
    } else if (currentMode === "duha") {
      cells[6].textContent = waktuStr;
    } else if (currentMode === "zuhur") {
      cells[7].textContent = waktuStr;
    } else if (currentMode === "checkout") {
      cells[8].textContent = waktuStr;
    }

    resultEl.textContent = `‚úÖ ${siswa.nama} (${nisn}) ${currentMode} dicatat`;
  }

  // inisialisasi kamera
  codeReader.listVideoInputDevices().then(devices => {
    if (!devices.length) {
      debugEl.textContent = "‚ùå Kamera tidak ditemukan";
      return;
    }
    const cam = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];
    codeReader.decodeFromVideoDevice(cam.deviceId, videoElement, (resultObj, err) => {
      if (resultObj) {
        const nisn = resultObj.text.trim();
        const now = Date.now();
        if (nisn !== lastScanned || now - lastScanTime > SCAN_COOLDOWN_MS) {
          lastScanned = nisn;
          lastScanTime = now;
          prosesAbsensi(nisn);
        }
      } else if (err && !(err instanceof ZXing.NotFoundException)) {
        debugEl.textContent = "‚ö†Ô∏è Error scan: " + err;
      }
    });
  }).catch(err => {
    debugEl.textContent = "‚ö†Ô∏è Gagal akses kamera: " + err;
    console.error(err);
  });
</script>
</body>
</html>
