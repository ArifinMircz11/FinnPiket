<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Pindai Barcode</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 900px;
        }
        #interactive.viewport {
            width: 100%;
            height: 300px;
        }
        #interactive.viewport > canvas, #interactive.viewport > video {
            max-width: 100%;
            width: 100%;
            height: auto;
            border-radius: 0.75rem;
        }
    </style>
</head>
<body class="flex flex-col items-center p-4">

    <div class="container w-full bg-white shadow-xl rounded-xl p-8 space-y-6">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Absensi Siswa</h1>
            <span id="hasil" class="text-xl sm:text-2xl font-extrabold text-blue-600 mt-4 sm:mt-0">Kode Siswa: -</span>
        </header>

        <main class="space-y-6">
            <div id="pindai-area" class="flex flex-col items-center">
                <p class="text-center text-lg text-gray-700 mb-4">Silakan pindai barcode siswa...</p>
                <div id="interactive" class="viewport w-full rounded-xl overflow-hidden"></div>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mt-4">
                    <button id="start-btn" class="bg-green-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-600 transition-colors">Mulai Pindai</button>
                    <button id="stop-btn" class="bg-red-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-600 transition-colors">Hentikan Pindai</button>
                    <button id="absensi-pulang-btn" class="bg-yellow-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-yellow-600 transition-colors">Absen Pulang (Demo)</button>
                </div>
                <div id="message-box" class="mt-4 p-3 w-full bg-red-100 text-red-700 rounded-lg hidden"></div>
            </div>

            <div class="overflow-x-auto shadow-md rounded-xl">
                <table id="tabel" class="min-w-full bg-white">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600">No.</th>
                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600">ID Siswa</th>
                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600">Nama</th>
                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600">Waktu Pagi</th>
                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600">Waktu Pulang</th>
                        </tr>
                    </thead>
                    <tbody id="tabel-body" class="divide-y divide-gray-200">
                        <!-- Data absensi akan ditambahkan di sini secara dinamis -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        import Quagga from 'https://esm.sh/quagga@1.2.1';

        // ====================================================================
        // PENTING: PENGATURAN SUPABASE
        // Kode ini membutuhkan dua tabel di database Supabase Anda: 'siswa' dan 'absensi'.
        // Anda dapat menggunakan SQL berikut di "SQL Editor" di dashboard Supabase Anda.
        // Ganti <PROJECT_REF> dan <ANON_PUBLIC_KEY> dengan kredensial proyek Anda.
        // ====================================================================

        // 1. SKEMA TABEL SISWA
        // Tabel ini menyimpan data siswa (ID barcode dan nama).
        // Anda perlu mengisi tabel ini dengan data siswa Anda.
        //
        // create table siswa (
        //   id varchar(255) primary key,
        //   nama varchar(255) not null
        // );

        // 2. SKEMA TABEL ABSENSI
        // Tabel ini akan mencatat setiap absensi.
        // Fungsi absensi memiliki 'unique constraint' untuk mencegah absensi ganda
        // pada hari yang sama.
        //
        // create table absensi (
        //   id uuid primary key default gen_random_uuid(),
        //   siswa_id varchar(255) references siswa(id),
        //   jenis text,
        //   waktu timestamp with time zone default timezone('Asia/Jakarta'::text, now()),
        //   scanner text
        // );
        //
        // -- Tambahkan 'unique constraint' untuk mencegah duplikat harian
        // alter table absensi add constraint absensi_unique_pagi_pulang unique (siswa_id, jenis, (date(waktu)));

        // 3. ATUR KREDENSIAL SUPABASE ANDA DI SINI
        const SUPABASE_URL  = 'https://rhykjbefaojfjwyaouogc.supabase.co';
        const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJoeWtqYmVmYW9qZmp3eWF1b2djIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4OTU2NTMsImV4cCI6MjA3MDQ3MTY1M30.PkjhntpOBdiDnRPBflSYMnd0zbNwpfXBu-g3AFsiTA0';
        const sb = createClient(SUPABASE_URL, SUPABASE_ANON);

        const elHasil = document.getElementById('hasil');
        const tbody   = document.getElementById('tabel-body');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const absensiPulangBtn = document.getElementById('absensi-pulang-btn');
        const messageBox = document.getElementById('message-box');

        let isScanning = false;

        function showMessage(msg, type = 'error') {
            messageBox.textContent = msg;
            messageBox.className = `mt-4 p-3 w-full rounded-lg block ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        async function absenClient(siswaId, jenis = 'pagi') {
            elHasil.textContent = `Pindai: ${siswaId}`;

            // Insert data ke database
            try {
                const { data, error } = await sb
                    .from('absensi')
                    .insert({ siswa_id: siswaId, jenis, scanner: navigator.userAgent })
                    .select('waktu, jenis')
                    .maybeSingle();

                if (error) {
                    // Jika ada error unik (duplikasi), tampilkan pesan yang ramah pengguna
                    if (error.code === '23505') {
                        showMessage(`Absensi siswa ID ${siswaId} untuk waktu ${jenis} sudah tercatat hari ini.`, 'warning');
                    } else {
                        showMessage(`Error saat absen: ${error.message}`);
                    }
                    return;
                }
                showMessage(`Absensi siswa ID ${siswaId} berhasil dicatat!`, 'success');

                const jam = new Date().toLocaleTimeString('id-ID');
                const status = data ? 'OKE' : 'SUDAH ADA';

                // Ambil nama siswa
                const { data: siswa, error: eS } = await sb
                    .from('siswa').select('nama').eq('id', siswaId).maybeSingle();
                const nama = siswa?.nama ?? '-';

                // Render baris ke tabel
                if (tbody) {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 transition-colors";
                    tr.innerHTML = `
                        <td class="py-2 px-4 whitespace-nowrap">${tbody.children.length + 1}</td>
                        <td class="py-2 px-4 whitespace-nowrap">${siswaId}</td>
                        <td class="py-2 px-4 whitespace-nowrap">${nama}</td>
                        <td class="py-2 px-4 whitespace-nowrap">${jenis === 'pagi' ? `${jam} (${status})` : ''}</td>
                        <td class="py-2 px-4 whitespace-nowrap">${jenis === 'pulang' ? `${jam} (${status})` : ''}</td>
                    `;
                    tbody.prepend(tr);
                }
            } catch (err) {
                showMessage(`Terjadi kesalahan: ${err.message}`);
            }
        }

        function startScanner() {
            if (isScanning) return;
            isScanning = true;
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        facingMode: "environment" // Gunakan kamera belakang pada ponsel
                    }
                },
                decoder: {
                    readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "code_39_vin_reader", "codabar_reader", "upc_reader", "upc_e_reader", "i2of5_reader"]
                }
            }, function(err) {
                if (err) {
                    showMessage(`Gagal memulai kamera: ${err}`);
                    console.error(err);
                    return;
                }
                Quagga.start();
            });

            Quagga.onDetected(function(result) {
                const code = result.codeResult.code;
                if (code) {
                    console.log("Barcode terdeteksi: ", code);
                    absenClient(code, 'pagi');
                    // Menghentikan pemindaian setelah berhasil
                    Quagga.stop();
                    isScanning = false;
                }
            });
            startBtn.disabled = true;
            stopBtn.disabled = false;
        }

        function stopScanner() {
            if (!isScanning) return;
            Quagga.stop();
            isScanning = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }

        startBtn.addEventListener('click', startScanner);
        stopBtn.addEventListener('click', stopScanner);

        // Contoh absen pulang
        absensiPulangBtn.addEventListener('click', () => {
            const demoId = "123456789"; // Ganti dengan ID barcode demo
            absenClient(demoId, 'pulang');
        });

        // Pastikan Quagga diinisialisasi ulang jika jendela diubah ukurannya
        window.addEventListener('resize', () => {
            if (isScanning) {
                stopScanner();
                startScanner();
            }
        });
    </script>
</body>
</html>
